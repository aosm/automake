#! /bin/sh

# Regression test for a bug reported by Andrew Suffield.
# (Automake goes wild and try to rerun itself more than two time
# to fix the Makefiles.)

required='libtoolize'
. $srcdir/defs || exit 1

set -e

cat >>configure.in <<'END'
AC_CONFIG_AUX_DIR([autoconf])
AC_PROG_CC
AM_PROG_LIBTOOL
AC_CONFIG_FILES([autoconf/Makefile main/Makefile])
AC_OUTPUT
END

mkdir autoconf
mkdir main

: > autoconf/Makefile.am
echo 'SUBDIRS = autoconf main' >Makefile.am

cat >main/Makefile.am <<'END'
lib_LTLIBRARIES = lib0.la
lib0_la_SOURCES = 0.c
END

libtoolize --force --copy
$ACLOCAL
$AUTOCONF

test -f autoconf/ltmain.sh # Sanity check.
rm -f autoconf/ltmain.sh
$AUTOMAKE --add-missing --copy 2>stderr
cat stderr
grep 'running more than two' stderr && exit 1

# Since we are ensuring that 'running more than two' is not printed,
# also ensure that it can be printed.  This way if someone changes the
# wording of this message (s)he will remember to adjust this test.
grep 'running more than two' ../../automake
